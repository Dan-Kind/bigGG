import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import curve_fit


def damped_sine(t, A, gamma, omega, phi, C):
    """Damped sine with constant offset"""
    return A * np.exp(-gamma * t) * np.sin(omega * t + phi) + C


def plot_with_damped_fit(
    data,
    dt,
    xlabel="Time",
    ylabel="Displacement",
    title=None
):
    data = np.asarray(data, dtype=float)
    t = np.arange(len(data)) * dt

    # ---- initial parameter guesses ----
    A0 = 0.5 * (np.max(data) - np.min(data))
    gamma0 = 1e-4
    omega0 = 2 * np.pi * 5 / t[-1]   # assume a few oscillations
    phi0 = 0.0
    C0 = np.mean(data)

    p0 = [A0, gamma0, omega0, phi0, C0]

    # ---- curve fit ----
    params, _ = curve_fit(
        damped_sine,
        t,
        data,
        p0=p0,
        maxfev=50000
    )
    A, gamma, omega, phi, C = params

    print("\nFitted parameters:")
    print(f"Amplitude A     = {A:.6f}")
    print(f"Damping gamma   = {gamma:.6e}")
    print(f"Angular freq ω  = {omega:.6f}")
    print(f"Phase φ         = {phi:.6f}")
    print(f"Offset C        = {C:.6f}")

    # ---- smooth curve for plotting ----
    t_fit = np.linspace(t[0], t[-1], 2000)
    y_fit = damped_sine(t_fit, *params)

    # ---- plot ----
    plt.figure()
    plt.plot(t, data, 'x', label="Data")
    plt.plot(t_fit, y_fit, label="Damped sine fit")
    plt.xlabel(xlabel)
    plt.ylabel(ylabel)
    if title:
        plt.title(title)
    plt.legend()
    plt.tight_layout()
    plt.show()

    return params


def plot_dataset(
    data,
    dt,
    xlabel="Time (s)",
    ylabel="Displacement (cm)",
    title=None
):
    data = np.asarray(data, dtype=float)
    t = np.arange(len(data)) * dt

    plt.figure()
    plt.plot(t, data, 'x')
    plt.xlabel(xlabel)
    plt.ylabel(ylabel)
    if title:
        plt.title(title)
    plt.tight_layout()
    plt.show()

j1d = [2.6, 2.0, 1.4, 0.7, -0.1, -0.8, -1.5, -2.4,
       -2.8, -3.3, -3.7, -4, -4.2, -4.1, -4.0, -3.8,
       -3.4, -2.9, -2.4, -1.8, -1.1, -0.4, 0.3,
       1, 1.6, 2.2, 2.6, 3, 3.2, 3.3, 3.2, 3.1, 2.9,
       2.5, 2.0, 1.5, 0.9, 0.3, -0.4, -1.1, -1.7, -2.2,
       -2.7, -3.2, -3.5, -3.7, -3.7, -3.6, -3.5, -3.2,
       -2.9, -2.5, -1.9, -1.3, -0.7, 0, 0.5, 1.1, 1.6,
       2.0, 2.4, 2.6, 2.7, 2.8, 2.7, 2.5]

j1h = [2.6, 2.0, 1.4, 0.7, -0.1, -0.8, -1.5, -2.2,
       -2.8, -3.4, -3.7, -4, -4.2, -4.2, -4.1, -3.8,
       -3.4, -2.9, -2.5, -1.8, -1.1, -0.4, 0.3, 1.0,
       1.1, 1.6, 2.6, 2.9, 3.2, 3.3, 3.2, 3.1, 2.9,
       2.5, 2.0, 1.5, 0.8, 0.2, -0.5, -1.1, -1.7, -2.2,
       -2.8, -3.1, -3.5, -3.6, -3.7, -3.6, -3.5, -3.2,
       -2.8, -2.4, -1.9, -1.3, -0.7, -0.1, 0.5, 1.1, 1.6,
       2.0, 2.3, 2.6, 2.8, 2.8, 2.7, 2.5]

j2h = [-0.6, 1.0, 1.5, 2.2, 3.0, 3.8, 4.6, 5.4, 6.2, 6.8, 7.4, 7.9, 8.3, 8.5,
         8.6, 8.5, 8.4, 8.0, 7.5, 6.9, 6.2, 5.5, 4.7, 4.0, 3.3, 2.6, 2.0, 1.4,
         1.0, 0.7, 0.5, 0.5, 0.6, 0.8, 1.2, 1.7, 2.2, 2.9, 3.5, 4.2, 4.9, 5.6,
         6.2, 6.8, 7.3, 7.5, 7.9, 8.0, 8.0, 7.9, 7.7, 7.3, 6.9, 6.3, 5.7, 5.1,
         4.4, 3.8, 3.2, 2.6, 2.1, 1.7, 1.3, 1.1, 1.0, 1.1, 1.2, 1.5, 1.8, 2.3,
         2.8, 3.4, 3.9, 4.6, 5.1, 5.7, 6.2, 6.7, 7.1, 7.4, 7.5, 7.6, 7.5, 7.4,
         7.1, 6.8, 6.3, 5.9, 5.3, 4.7, 4.2, 3.6, 3.1, 2.6, 2.2, 1.9, 1.7, 1.5,
         1.5, 1.6, 1.8, 2.0, 2.3, 2.8, 3.2, 3.7, 4.2, 4.8, 5.3, 5.8, 6.2, 6.6,
         6.8, 7.0, 7.1, 7.2, 7.1, 6.9, 6.6, 6.3, 5.9, 5.4, 5.0, 4.5, 4.0, 3.5,
         3.1, 2.6, 2.4, 2.2, 2.0, 1.9, 2.0, 2.1, 2.2, 2.5, 2.8, 3.2, 3.6, 4.0,
         4.5, 4.9, 5.3, 5.7, 6.1, 6.4, 6.6, 6.7, 6.7, 6.7, 6.6, 6.4, 6.1, 5.8,
         5.5, 5.1, 4.6, 4.2, 3.8, 3.5, 3.1, 2.8, 2.5, 2.4, 2.3, 2.3, 2.3, 2.4,
         2.6, 2.9, 3.1, 3.5, 3.9, 4.2, 4.7, 5.0, 5.4, 5.7, 6.0, 6.2]

j2d = [-0.6, 1.0, 1.5, 2.2, 3.0, 3.8, 4.6, 5.4, 6.2, 6.8, 7.5, 8.0, 8.4, 8.5,
         8.6, 8.5, 8.4, 8.0, 7.5, 6.9, 6.2, 5.5, 4.7, 4.0, 3.3, 2.6, 2.0, 1.4,
         1.0, 0.7, 0.5, 0.5, 0.6, 0.8, 1.2, 1.7, 2.2, 2.9, 3.5, 4.2, 4.9, 5.7,
         6.2, 6.8, 7.3, 7.5, 7.9, 8.1, 8.0, 7.9, 7.7, 7.3, 6.9, 6.3, 5.7, 5.1,
         4.4, 3.9, 3.3, 2.6, 2.1, 1.7, 1.4, 1.2, 1.1, 1.1, 1.3, 1.5, 1.9, 2.3,
         2.8, 3.4, 4.0, 4.6, 5.2, 5.8, 6.2, 6.7, 7.1, 7.3, 7.5, 7.6, 7.5, 7.4,
         7.1, 6.8, 6.4, 5.9, 5.4, 4.8, 4.2, 3.6, 3.1, 2.6, 2.2, 1.9, 1.7, 1.6,
         1.6, 1.5, 1.8, 2.1, 2.4, 2.8, 3.2, 3.7, 4.3, 4.9, 5.3, 5.8, 6.2, 6.6,
         6.9, 7.0, 7.2, 7.2, 7.1, 6.9, 6.7, 6.3, 5.9, 5.5, 5.0, 4.5, 4.0, 3.6,
         3.1, 2.8, 2.5, 2.2, 2.0, 1.9, 2.0, 2.1, 2.3, 2.5, 2.8, 3.2, 3.6, 4.0,
         4.5, 4.9, 5.3, 5.8, 6.1, 6.4, 6.6, 6.7, 6.8, 6.7, 6.6, 6.4, 6.2, 5.9,
         5.5, 5.1, 4.7, 4.3, 3.9, 3.5, 3.1, 2.8, 2.5, 2.4, 2.3, 2.3, 2.3, 2.4,
         2.6, 2.9, 3.2, 3.5, 3.9, 4.2, 4.7, 5.0, 5.4, 5.7, 6.0, 6.2]

r2 = [0.4, 0.7, 1.2, 1.9, 2.7, 2.5, 4.3, 5.2, 6.0, 6.8, 7.5, 8.1, 8.5, 8.9, 9.1, 9.1, 8.9, 8.7, 8.3, 7.75, 7.05, 6.4, 5.6, 4.8, 4.0, 3.25, 2.55, 1.95, 1.45, 1.0,
0.8, 0.7, 0.7, 0.9, 1.2, 1.6, 2.1, 2.75, 3.45, 4.2, 4.9, 5.6, 6.3, 6.95, 7.5, 7.95, 8.25, 8.45, 8.5, 8.4, 8.2, 7.9, 7.45, 6.95, 6.35, 5.7, 5.05, 4.4, 3.7, 3.1, 2.5, 2.05, 1.7, 1.45,
1.3, 1.25, 1.4, 1.6, 1.95, 2.35, 2.85, 3.45, 4.0, 4.65, 5.3, 5.9, 6.4, 6.95, 7.35, 7.65, 7.85, 8.5, 7.9, 7.8, 7.55, 7.2, 6.8, 6.3, 5.8, 5.2, 4.6, 4.05, 3.5, 3.0, 2.6,
2.25, 2.0, 1.8, 1.75, 1.8, 2.0, 2.2, 2.55, 3.0, 3.45, 3.95, 4.5, 5.0, 5.55, 6.0, 6.5, 6.85, 7.15, 7.35, 7.5, 7.5, 7.4, 7.2, 7.0, 6.65, 6.25, 5.8, 5.35, 4.85, 4.35, 3.9,
3.4, 3.05, 2.7, 2.45, 2.3, 2.2, 2.2, 2.35, 2.5, 2.8, 3.1, 3.5, 3.95, 4.35, 4.85, 5.3, 5.7, 6.1, 6.5, 6.75, 7.0, 7.1, 7.1, 7.1, 7.0, 6.8, 6.5, 6.2, 5.8, 5.4, 5.0, 4.55,
4.15, 3.75, 3.4, 3.1, 2.85, 2.7, 2.6, 2.55, 2.65, 2.75, 3.0, 3.2, 3.55, 3.9, 4.3, 4.7, 5.1, 5.45, 5.8, 6.1, 6.4, 6.6]
r1 = [4.45, 3.75, 2.9, 2.0, 1.0, -0.05, -1, -1.9, -2.75, -3.55, -4.15, - 4.6, -4.95, -5.05, -5.0, -4.8, -4.4, -3.8, -3.1, -2.35, -1.45, -0.5, 0.4, 1.35, 2.2,
     2.95, 3.6, 4.2, 4.55, 4.8, 4.85, 4.7, 4.4, 4.0, 3.45, 2.8, 2.0, 1.2, 0.3, -0.5, -1.4, -2.1, -2.9, -3.4, -3.9, -4.2, -4.35, -4.35, -4.15, -3.9, -3.45,
     -2.9, -2.2, -1.5, -0.7, 0.1, 0.9, 1.7, 2.35, 3.0, 3.5, 3.9, 4.1, 4.2, 4.15, 3.95, 3.6]
def data_averager(l1, l2):
    if len(l1) != len(l2):
        return IOError
    else:
        return [int(((i+j)/2)*1000)/1000 for i, j in zip(l1, l2)]
if __name__ == '__main__':
    plot_with_damped_fit(r1,15)

